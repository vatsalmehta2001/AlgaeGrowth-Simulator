---
phase: 01-foundation-core-model
plan: 02
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/simulation/light.py
  - tests/test_light.py
autonomous: true

must_haves:
  truths:
    - "Beer-Lambert correctly computes light attenuation at any depth"
    - "Depth-averaged irradiance decreases for deeper ponds"
    - "Depth-averaged irradiance decreases for denser cultures"
    - "Very shallow or very clear ponds return near-surface irradiance"
    - "Deeper ponds (>0.3m) show measurable attenuation vs shallow ponds"
  artifacts:
    - path: "src/simulation/light.py"
      provides: "Beer-Lambert attenuation and depth-averaged irradiance functions"
      exports: ["beer_lambert", "depth_averaged_irradiance"]
      min_lines: 40
    - path: "tests/test_light.py"
      provides: "Unit tests for light attenuation module"
      min_lines: 60
  key_links:
    - from: "src/simulation/light.py"
      to: "src/models/parameters.py"
      via: "Uses LightParams fields (sigma_x, background_turbidity)"
      pattern: "sigma_x|background_turbidity"
---

<objective>
Implement Beer-Lambert light attenuation and depth-averaged irradiance using TDD.

Purpose: Light attenuation is one of two core limiting factors in the growth model (SIM-02). The depth-averaged irradiance function is critical because algae at different pond depths receive different light levels. Using surface irradiance alone overestimates growth by 20-50% (per RESEARCH.md pitfall #4). The analytical depth-averaging formula provides an exact solution.

Output: Working, tested `light.py` module with `beer_lambert()` and `depth_averaged_irradiance()` functions.
</objective>

<execution_context>
@/Users/vatsalmehta/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vatsalmehta/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-model/01-CONTEXT.md
@.planning/phases/01-foundation-core-model/01-RESEARCH.md
@.planning/phases/01-foundation-core-model/01-01-SUMMARY.md
</context>

<feature>
  <name>Beer-Lambert Light Attenuation and Depth-Averaged Irradiance</name>
  <files>src/simulation/light.py, tests/test_light.py</files>
  <behavior>
Two pure functions, no side effects, no mutation:

**beer_lambert(I0, sigma_x, biomass_conc, depth, k_bg=0.0) -> float**
Computes irradiance at a specific depth using Beer-Lambert law.
Formula: I(z) = I0 * exp(-(sigma_x * X + k_bg) * z)

Cases:
- beer_lambert(500, 0.2, 1.0, 0.0) -> 500.0 (surface = full irradiance)
- beer_lambert(500, 0.2, 1.0, 0.3, 0.5) -> 500 * exp(-(0.2*1.0+0.5)*0.3) = 500 * exp(-0.21) = ~404.9
- beer_lambert(500, 0.2, 0.0, 0.3, 0.0) -> 500.0 (no biomass, no bg = no attenuation)
- beer_lambert(0, 0.2, 1.0, 0.3) -> 0.0 (no incoming light)
- beer_lambert(500, 0.2, 1.0, 1.0, 0.5) -> 500 * exp(-0.7) = ~248.4 (deep pond, significant attenuation)

**depth_averaged_irradiance(I0, sigma_x, biomass_conc, depth, k_bg=0.0) -> float**
Analytical depth-averaged irradiance across the full pond depth.
Formula: I_avg = I0 / (K * D) * (1 - exp(-K * D)) where K = sigma_x * X + k_bg

Cases:
- depth_averaged_irradiance(500, 0.2, 1.0, 0.3, 0.5) -> 500 / (0.7*0.3) * (1 - exp(-0.7*0.3)) = ~447.0
- depth_averaged_irradiance(500, 0.2, 1.0, 0.5, 0.5) -> ~404.3 (deeper = less avg light)
- depth_averaged_irradiance(500, 0.2, 5.0, 0.3, 0.5) -> ~263.9 (denser culture = less avg light)
- depth_averaged_irradiance(500, 0.0, 0.0, 0.3, 0.0) -> 500.0 (no extinction = full light)
- depth_averaged_irradiance(0, 0.2, 1.0, 0.3) -> 0.0 (no incoming light)

Key behavioral properties to test:
- Deeper ponds get less average light than shallow ponds (same biomass)
- Denser cultures get less average light than dilute cultures (same depth)
- Depth-averaged is always between surface and bottom irradiance
- depth_averaged >= beer_lambert at full depth (average is always above bottom)
- With zero extinction (K=0), returns I0 (degenerate case)
- Phase 1 success criterion: >0.3m depth shows measurable attenuation
  </behavior>
  <implementation>
Implement as pure functions in src/simulation/light.py. Use numpy for exp.

Key implementation details:
- Guard against K*D near zero (< 1e-10) to avoid division by zero — return I0 in that case
- Guard against I0 <= 0 — return 0.0
- Do NOT import from src.models.parameters — these functions take raw floats, not dataclass objects. This keeps them maximally testable and reusable.
- Include docstrings with source citations: Razzak et al. (2024) Eq. 18-19, Schediwy et al. (2019) Eq. 3, 10
- Update src/simulation/__init__.py to export both functions

Test structure (tests/test_light.py):
- test_beer_lambert_surface: depth=0 returns I0
- test_beer_lambert_known_values: Check against hand-calculated values (rel=1e-3)
- test_beer_lambert_no_biomass: biomass=0, k_bg=0 returns I0
- test_beer_lambert_no_light: I0=0 returns 0
- test_depth_avg_known_values: Check against analytical formula results (rel=1e-3)
- test_depth_avg_deeper_is_darker: I_avg(depth=0.5) < I_avg(depth=0.1) for same biomass
- test_depth_avg_denser_is_darker: I_avg(biomass=5.0) < I_avg(biomass=1.0) for same depth
- test_depth_avg_between_surface_and_bottom: I_bottom <= I_avg <= I_surface
- test_depth_avg_no_extinction: K near 0 returns I0
- test_depth_avg_no_light: I0=0 returns 0
- test_depth_attenuation_visible_above_03m: measurable difference between 0.1m and 0.3m+
  </implementation>
</feature>

<verification>
1. `pytest tests/test_light.py -v` — all 11+ tests pass
2. `python -c "from src.simulation.light import depth_averaged_irradiance; print(depth_averaged_irradiance(500, 0.2, 1.0, 0.1, 0.5))"` — returns value near 500 (shallow)
3. `python -c "from src.simulation.light import depth_averaged_irradiance; print(depth_averaged_irradiance(500, 0.2, 1.0, 0.5, 0.5))"` — returns value noticeably less than shallow
4. No imports from src.config or src.simulation.growth in light.py (pure, standalone module)
</verification>

<success_criteria>
- beer_lambert and depth_averaged_irradiance functions exist and are exported
- All test cases pass with pytest.approx(rel=1e-3) for known values
- Deeper ponds and denser cultures demonstrably get less average light
- >0.3m depth shows measurable attenuation (Phase 1 success criterion #2)
- Functions are pure (no side effects, no state, no imports beyond numpy)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-model/01-02-SUMMARY.md`
</output>
